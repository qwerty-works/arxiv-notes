---
import BaseLayout from './BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';

const { entry, prev, next, related, bodyHasPromptsSection } = Astro.props as {
  entry: CollectionEntry<'papers'>;
  prev: CollectionEntry<'papers'> | null;
  next: CollectionEntry<'papers'> | null;
  related: CollectionEntry<'papers'>[];
  bodyHasPromptsSection?: boolean;
};

const fm = entry.data;
const title = `${fm.catchyTitle} — arxiv-notes`;
const description = fm.blurb;

const BASE = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
function href(path: string) {
  return `${BASE}${path.replace(/^\/+/, '')}`;
}

const canonical = `${fm.arxivId}/${entry.slug.split('/').slice(1).join('/')}/`;
---

<BaseLayout title={title} description={description} canonical={canonical}>
  <article class="paper article">
    <h1><em>{fm.catchyTitle}</em></h1>
    <div class="subhead" style="font-size:17px; line-height:1.4">{fm.funnySubtitle}</div>
    <div class="byline">{fm.publishedAt.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' }).toUpperCase().replace(',', ', ')}</div>

    <div class="source">
      Source: <a href={fm.sourceUrl} target="_blank" rel="noopener noreferrer">arXiv</a>
      <span style="color:var(--muted)">·</span>
      <span style="color:var(--muted)">{fm.paperTitle}</span>
      <span style="color:var(--muted)">·</span>
      <button id="favBtn" type="button" style="border:1px solid var(--border); background:transparent; color:var(--muted); padding:2px 8px; border-radius:999px; cursor:pointer" aria-label="Toggle favorite" title="Favorite">☆</button>
    </div>

    <script type="module">
      const LOCAL_STORE_URL = ${JSON.stringify(href('local-store.js'))};
      const arxivId = ${JSON.stringify(fm.arxivId)};
      const title = ${JSON.stringify(fm.catchyTitle)};
      const slug = ${JSON.stringify(entry.slug.split('/').slice(1).join('/'))};

      const btn = document.getElementById('favBtn');
      if (btn){
        const setUi = (on) => {
          btn.textContent = on ? '★' : '☆';
          btn.style.color = on ? 'var(--accent)' : 'var(--muted)';
        };

        (async () => {
          try {
            const { isFavorite, setFavorite, removeFavorite } = await import(LOCAL_STORE_URL);

            const init = async () => {
              try{
                const on = await isFavorite(arxivId);
                setUi(on);
              }catch{}
            };

            btn.addEventListener('click', async () => {
              try{
                const on = await isFavorite(arxivId);
                if (on){
                  await removeFavorite(arxivId);
                  setUi(false);
                } else {
                  await setFavorite({ arxivId, slug, title, savedAt: Date.now() });
                  setUi(true);
                }
              }catch{
                alert('Could not save favorite (browser storage blocked?)');
              }
            });

            init();
          } catch {
            // local-store failed to load (bad base path?)
            btn.title = 'Favorites unavailable (failed to load local storage helper)';
          }
        })();
      }
    </script>

    <section class="paper tldr" style="margin-top:14px; padding:14px 14px 12px">
      <h2 style="margin:0 0 8px; font-size:14px; letter-spacing:0.02em; text-transform:uppercase; color:var(--muted)">TL;DR</h2>
      <div style="font-size:15px; line-height:1.5">{fm.tldr}</div>
    </section>

    <div class="tags">
      {fm.tags.map((t) => (
        <a class="tag" href={href(`tags/${encodeURIComponent(t)}/`)}>
          #{t}
        </a>
      ))}
    </div>

    <div style="margin-top:14px">
      <slot />
    </div>

    {!bodyHasPromptsSection ? (
      <section class="paper prompts" style="margin-top:14px; padding:14px 14px 12px">
        <h2 style="margin:0 0 10px; font-size:14px; letter-spacing:0.02em; text-transform:uppercase; color:var(--muted)">Copy/paste prompts</h2>
        <div class="promptList">
          {fm.prompts.map((p) => (
            <div class="promptCard">
              <div class="promptTop">
                <div class="promptTitle">{p.title}</div>
                <button class="copyBtn" type="button" data-copy={p.prompt} aria-label={`Copy prompt: ${p.title}`}>
                  Copy
                </button>
              </div>
              <pre class="promptPre"><code>{p.prompt}</code></pre>
            </div>
          ))}
        </div>
      </section>
    ) : null}

    {related.length ? (
      <section class="related">
        <h3>Related</h3>
        {related.map((r) => {
          const shared = (r.data.tags || []).filter((t) => (fm.tags || []).includes(t));
          const why = shared.length ? `Also about: ${shared.slice(0, 2).join(', ')}` : '';
          return (
            <a href={href(`${r.data.arxivId}/${r.slug.split('/').slice(1).join('/')}/`)}>
              <strong>{r.data.catchyTitle}</strong>
              <div style="color:var(--muted); font-size:13px; margin-top:2px">{r.data.blurb}</div>
              {why ? (
                <div style="color:var(--muted); font-size:12px; margin-top:6px">{why}</div>
              ) : null}
            </a>
          );
        })}
      </section>
    ) : null}

    <nav class="pager" aria-label="Previous and next">
      {prev ? (
        <a href={href(`${prev.data.arxivId}/${prev.slug.split('/').slice(1).join('/')}/`)}>
          <div class="label">Previous</div>
          <div class="name">{prev.data.catchyTitle}</div>
        </a>
      ) : (
        <div></div>
      )}

      {next ? (
        <a href={href(`${next.data.arxivId}/${next.slug.split('/').slice(1).join('/')}/`)}>
          <div class="label">Next</div>
          <div class="name">{next.data.catchyTitle}</div>
        </a>
      ) : (
        <div></div>
      )}
    </nav>
  </article>
</BaseLayout>
