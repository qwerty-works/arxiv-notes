---
import { getCollection } from 'astro:content';
import PaperLayout from '../../layouts/PaperLayout.astro';

export async function getStaticPaths() {
  const papers = await getCollection('papers');
  return papers.map((entry) => {
    const [, slug] = entry.slug.split('/');
    return {
      params: { arxiv: entry.data.arxivId, slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const papers = (await getCollection('papers'))
  .slice()
  .sort((a, b) => a.data.publishedAt.getTime() - b.data.publishedAt.getTime());

const idx = papers.findIndex((p) => p.id === entry.id);
const prev = idx > 0 ? papers[idx - 1] : null;
const next = idx >= 0 && idx < papers.length - 1 ? papers[idx + 1] : null;

// Related by shared tags (simple intersection)
const tags = new Set(entry.data.tags);
const related = papers
  .filter((p) => p.id !== entry.id)
  .map((p) => {
    const score = p.data.tags.reduce((acc, t) => acc + (tags.has(t) ? 1 : 0), 0);
    return { p, score };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || b.p.data.publishedAt.getTime() - a.p.data.publishedAt.getTime())
  .slice(0, 3)
  .map((x) => x.p);
---

<PaperLayout entry={entry} prev={prev} next={next} related={related}>
  <div class="prose">
    <Content />
  </div>
</PaperLayout>
