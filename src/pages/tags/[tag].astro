---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const papers = await getCollection('papers');
  const tags = new Set();
  for (const p of papers) for (const t of p.data.tags) tags.add(t);
  // NOTE: Astro will URL-encode params when generating routes.
  // If we pre-encode here, we double-encode and tag links 404 on GH Pages.
  return Array.from(tags).map((tag) => ({ params: { tag } }));
}

const rawTag = decodeURIComponent(Astro.params.tag);
const papers = (await getCollection('papers'))
  .filter((p) => p.data.tags.includes(rawTag))
  .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

const BASE = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
function href(path) {
  return `${BASE}${path.replace(/^\/+/, '')}`;
}

function paperUrl(p) {
  const slug = p.slug.split('/').slice(1).join('/');
  return href(`${p.data.arxivId}/${slug}/`);
}

const title = `#${rawTag} â€” arxiv-notes`;
const description = `Papers tagged with ${rawTag}.`;
---

<BaseLayout title={title} description={description} canonical={`tags/${encodeURIComponent(rawTag)}/`}>
  <section class="paper article">
    <h1>#{rawTag}</h1>
    <p class="subhead">{papers.length} post(s).</p>

    <div class="list" style="margin-top:12px">
      {papers.map((p) => (
        <a class="cardLink" href={paperUrl(p)}>
          <div class="cardTitle">{p.data.catchyTitle}</div>
          <div class="cardSub">{p.data.blurb}</div>
        </a>
      ))}
    </div>
  </section>
</BaseLayout>
